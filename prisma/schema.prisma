generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  name            String?
  timezone        String   @default("America/Los_Angeles")
  phoneE164       String?  @unique
  smsConsent      Boolean  @default(false)
  quietHours      Json?
  dailyMsgCount   Int      @default(0)
  lastMsgDate     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  cycles       Cycle[]
  uploads      Upload[]
  checkIns     CheckIn[]
  messages     MessageLog[]
  chatMessages ChatMessage[]
  convoStates  ConversationState[]
}

model Cycle {
  id        String   @id @default(cuid())
  userId    String
  status    String   @default("ACTIVE")
  startDate DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User               @relation(fields: [userId], references: [id])
  protocol     ProtocolPlan?
  planDays     PlanDay[]
  tasks        Task[]
  checkIns     CheckIn[]
  chatMessages ChatMessage[]
  convoState   ConversationState?
}

model Upload {
  id            String   @id @default(cuid())
  userId        String
  cycleId       String?
  kind          String
  storageKey    String
  mimeType      String
  status        String   @default("UPLOADED")
  extractedText String?
  fileData      Bytes?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model ProtocolPlan {
  id             String   @id @default(cuid())
  cycleId        String   @unique
  status         String   @default("DRAFT")
  source         String
  cycleStartDate DateTime
  notes          String?
  rawDocumentUrl String?
  structuredData Json
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  cycle        Cycle         @relation(fields: [cycleId], references: [id])
  medications  Medication[]
  appointments Appointment[]
  milestones   Milestone[]
}

model Medication {
  id             String  @id @default(cuid())
  protocolPlanId String
  name           String
  dosageAmount   Float?
  dosageUnit     String?
  dosage         String?
  frequency      String  @default("once_daily")
  route          String?
  startDayOffset Int
  durationDays   Int
  timeOfDay      String?
  exactTime      String?
  instructions   String?

  protocolPlan ProtocolPlan @relation(fields: [protocolPlanId], references: [id], onDelete: Cascade)
}

model Appointment {
  id             String   @id @default(cuid())
  protocolPlanId String
  type           String
  dayOffset      Int
  exactTime      String?
  duration       Int?
  location       String?
  notes          String?
  fasting        Boolean  @default(false)
  critical       Boolean  @default(false)

  protocolPlan ProtocolPlan @relation(fields: [protocolPlanId], references: [id], onDelete: Cascade)
}

model Milestone {
  id             String  @id @default(cuid())
  protocolPlanId String
  type           String
  dayOffset      Int
  label          String?
  details        String?

  protocolPlan ProtocolPlan @relation(fields: [protocolPlanId], references: [id], onDelete: Cascade)
}

model PlanDay {
  id            String   @id @default(cuid())
  cycleId       String
  date          DateTime
  cycleDayIndex Int
  title         String
  summary       String?
  createdAt     DateTime @default(now())

  cycle Cycle  @relation(fields: [cycleId], references: [id])
  tasks Task[]
}

model Task {
  id         String    @id @default(cuid())
  cycleId    String
  planDayId  String?
  kind       String
  label      String
  dueAt      DateTime?
  timeWindow Json?
  status     String    @default("PENDING")
  meta       Json?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  cycle   Cycle    @relation(fields: [cycleId], references: [id])
  planDay PlanDay? @relation(fields: [planDayId], references: [id])
}

model CheckIn {
  id        String   @id @default(cuid())
  userId    String
  cycleId   String
  mood      Int?
  symptoms  String[]
  note      String?
  source    String   @default("SMS")
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  cycle Cycle @relation(fields: [cycleId], references: [id])
}

model MessageLog {
  id                String   @id @default(cuid())
  userId            String
  direction         String
  channel           String   @default("SMS")
  toNumber          String?
  fromNumber        String?
  body              String
  providerMessageId String?
  createdAt         DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model ConversationState {
  id        String   @id @default(cuid())
  userId    String
  cycleId   String   @unique
  summary   String   @default("")
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id])
  cycle Cycle @relation(fields: [cycleId], references: [id])
}

model ChatMessage {
  id        String   @id @default(cuid())
  userId    String
  cycleId   String
  sender    String   // SYSTEM, USER, BUDDY
  type      String   // REMINDER, CHECKIN, APPOINTMENT, INFO, MESSAGE
  content   String
  meta      Json?    // Extra data (medicationId, appointmentId, mood, etc.)
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  cycle Cycle @relation(fields: [cycleId], references: [id])

  @@index([userId, cycleId, createdAt])
}
